<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Podsumowanie SocialMedia</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/startbootstrap-sb-admin@7.0.6/dist/css/styles.min.css" rel="stylesheet">
    <style>
        .navbar-brand img { background-color: transparent; filter: brightness(0) invert(1); }
        .preview-img {max-width:100px;max-height:100px;margin:5px;border-radius:8px;box-shadow:0 2px 8px #0002;}
        .preview-video {max-width:200px;max-height:150px;margin:5px;border-radius:8px;box-shadow:0 2px 8px #0002;}
        .post-card {border-left:4px solid #0d6efd;padding:15px;margin-bottom:15px;background:#f8f9fa;border-radius:8px;}
        .post-card-sent {border-left:4px solid #198754;}
    </style>
</head>
<body class="sb-nav-fixed">
<nav class="sb-topnav navbar navbar-expand navbar-dark bg-dark">
    <a class="navbar-brand ps-3" href="/" style="display: flex; align-items: center; gap: 10px;">
        <img src="/static/Logo.png" alt="Logo" style="height: 50px; width: auto;">
    </a>
    <ul class="navbar-nav ms-auto me-3">
        <li class="nav-item text-white d-flex align-items-center">Zalogowany jako: <b class="ms-2">{{ username }}</b></li>
        <li class="nav-item"><a href="/logout" class="btn btn-outline-danger btn-sm ms-3">Wyloguj</a></li>
    </ul>
</nav>
<div id="layoutSidenav">
    <div id="layoutSidenav_nav">
        <nav class="sb-sidenav accordion sb-sidenav-dark" id="sidenavAccordion">
            <div class="sb-sidenav-menu">
                <div class="nav">
                    <a class="nav-link" href="/">
                        <div class="sb-nav-link-icon"><i class="fas fa-home"></i></div>
                        Strona g≈Ç√≥wna
                    </a>
                    <a class="nav-link" href="/wygeneruj-sociale">
                        <div class="sb-nav-link-icon"><i class="fas fa-share-alt"></i></div>
                        Wygeneruj Sociale
                    </a>
                    <a class="nav-link active" href="/podsumowanie-socialmedia">
                        <div class="sb-nav-link-icon"><i class="fas fa-list-check"></i></div>
                        Podsumowanie SocialMedia
                    </a>
                </div>
            </div>
        </nav>
    </div>
    <div id="layoutSidenav_content">
        <main>
            <div class="container-fluid px-4 mt-4">
                <h1 class="mt-4">Podsumowanie SocialMedia</h1>
                <ol class="breadcrumb mb-4">
                    <li class="breadcrumb-item"><a href="/">Panel API</a></li>
                    <li class="breadcrumb-item active">Podsumowanie SocialMedia</li>
                </ol>
                
                <div class="card mb-4">
                    <div class="card-header"><i class="fas fa-clock"></i> Posty do wys≈Çania ({{ posts_to_send|length }})</div>
                    <div class="card-body">
                        {% if posts_to_send %}
                            {% for post in posts_to_send %}
                            <div class="post-card">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <b>Wys≈Çaƒá: {{ post.send_at.strftime('%Y-%m-%d %H:%M') }}</b><br>
                                        <span class="text-muted small">Dodano: {{ post.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                                    </div>
                                </div>
                                <p class="mt-2 mb-2">{{ post.description }}</p>
                                <!-- DEBUG: post.images = "{{ post.images }}" -->
                                <!-- DEBUG: post.video = "{{ post.video }}" -->
                                {% if post.images %}
                                    <div class="mb-2 image-container">
                                        {% for img in post.images.split(',') %}
                                            <!-- DEBUG LOOP: img = "{{ img }}" -->
                                            <img data-dropbox-path="{{ img }}" class="preview-img dropbox-image" alt="Zdjƒôcie" style="cursor: pointer;">
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                {% if post.video %}
                                    <video data-dropbox-path="{{ post.video }}" class="preview-video dropbox-video" controls style="display:none;"></video>
                                {% endif %}
                            </div>
                            {% endfor %}
                        {% else %}
                            <span class="text-muted">Brak post√≥w do wys≈Çania.</span>
                        {% endif %}
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header"><i class="fas fa-check-circle"></i> Posty wys≈Çane ({{ posts_sent|length }})</div>
                    <div class="card-body">
                        {% if posts_sent %}
                            {% for post in posts_sent %}
                            <div class="post-card post-card-sent">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <b>Wys≈Çano: {{ post.created_at.strftime('%Y-%m-%d %H:%M') }}</b><br>
                                        <span class="text-muted small text-success"><i class="fas fa-check"></i> Gotowe do wys≈Çania na n8n</span>
                                    </div>
                                </div>
                                <p class="mt-2 mb-2">{{ post.description }}</p>
                                <!-- DEBUG: post.images = "{{ post.images }}" -->
                                <!-- DEBUG: post.video = "{{ post.video }}" -->
                                {% if post.images %}
                                    <div class="mb-2 image-container">
                                        {% for img in post.images.split(',') %}
                                            <!-- DEBUG LOOP: img = "{{ img }}" -->
                                            <img data-dropbox-path="{{ img }}" class="preview-img dropbox-image" alt="Zdjƒôcie" style="cursor: pointer;">
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                {% if post.video %}
                                    <video data-dropbox-path="{{ post.video }}" class="preview-video dropbox-video" controls style="display:none;"></video>
                                {% endif %}
                            </div>
                            {% endfor %}
                        {% else %}
                            <span class="text-muted">Brak wys≈Çanych post√≥w.</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </main>
        <footer class="py-4 bg-light mt-auto">
            <div class="container-fluid px-4">
                <div class="d-flex align-items-center justify-content-between small">
                    <div class="text-muted">Copyright &copy; SocialMedia Flask API 2026</div>
                </div>
            </div>
        </footer>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/startbootstrap-sb-admin@7.0.6/dist/js/scripts.min.js"></script>
<script>
    // Pobierz linki z Dropboxa i wy≈õwietl zdjƒôcia/video
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üîµ Inicjalizacja ≈Çadowania z Dropboxa...');
        
        // Pobierz wszystkie zdjƒôcia i video kt√≥re czekajƒÖ na linki
        const images = document.querySelectorAll('.dropbox-image');
        const videos = document.querySelectorAll('.dropbox-video');
        
        console.log(`Znaleziono ${images.length} zdjƒôƒá i ${videos.length} video`);
        
        // Funkcja do pobierania z Dropboxa
        function loadDropboxFile(element, isVideo = false) {
            const dropboxPath = element.getAttribute('data-dropbox-path');
            if (!dropboxPath) {
                console.warn('‚ö† Brak ≈õcie≈ºki Dropboxa dla elementu:', element);
                return;
            }
            
            console.log(`\n‚û§ Pobieranie ${isVideo ? 'VIDEO' : 'ZDJƒòCIE'}`);
            console.log(`  Path: ${dropboxPath}`);
            console.log(`  Type: ${typeof dropboxPath}, Length: ${dropboxPath.length}`);
            
            try {
                const encodedPath = encodeURIComponent(dropboxPath);
                const url = `/dropbox-file?path=${encodedPath}`;
                
                console.log(`  Encoded: ${encodedPath.substring(0, 80)}...`);
                console.log(`  URL: ${url.substring(0, 100)}...`);
                
                element.src = url;
                element.onerror = function() {
                    console.error(`‚úó B≈ÇƒÖd ≈Çadowania: ${dropboxPath}`);
                    element.style.display = 'none';
                    element.title = 'B≈ÇƒÖd ≈Çadowania z Dropboxa';
                };
                element.onload = function() {
                    console.log(`‚úì Za≈Çadowano: ${dropboxPath}`);
                };
                
                if (isVideo) {
                    element.style.display = 'block';
                }
            } catch (err) {
                console.error(`‚úó B≈ÇƒÖd ustawiania src:`, err.message);
            }
        }
        
        // Za≈Çaduj wszystkie zdjƒôcia
        console.log('\nüì∑ ≈Åadowanie zdjƒôƒá:');
        images.forEach((img, idx) => {
            console.log(`  [${idx}] ${img.getAttribute('data-dropbox-path')}`);
            loadDropboxFile(img, false);
        });
        
        // Za≈Çaduj wszystkie video
        console.log('\nüé¨ ≈Åadowanie video:');
        videos.forEach((video, idx) => {
            console.log(`  [${idx}] ${video.getAttribute('data-dropbox-path')}`);
            loadDropboxFile(video, true);
        });
        
        console.log('\n‚úì Inicjalizacja zako≈Ñczona');
    });
</script>
</body>
</html>
