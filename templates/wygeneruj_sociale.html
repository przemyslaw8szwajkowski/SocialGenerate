<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wygeneruj Sociale</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/startbootstrap-sb-admin@7.0.6/dist/css/styles.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        .navbar-brand img { background-color: transparent; filter: brightness(0) invert(1); }
        .preview-img {max-width:120px;max-height:120px;margin:5px;border-radius:8px;box-shadow:0 2px 8px #0002;transition:transform .2s;}
        .preview-img:hover {transform:scale(1.08);}
        .preview-video {max-width:320px;max-height:240px;margin:5px;border-radius:8px;box-shadow:0 2px 8px #0002;}
        .preview-gallery {display:flex;flex-wrap:wrap;gap:10px;}
        .preview-label {font-weight:600;margin-bottom:6px;}
        #map {height:400px;border-radius:8px;margin-top:10px;box-shadow:0 2px 8px #0002;}
        .location-info {background:#f8f9fa;padding:15px;border-radius:8px;margin-top:10px;border-left:4px solid #007bff;}
        .location-coords {font-family:monospace;color:#495057;}
        .map-screenshot-container {margin-top:15px;padding:15px;background:#fff;border-radius:8px;border:2px dashed #007bff;display:none;}
        .map-screenshot-preview {max-width:100%;height:auto;border-radius:6px;margin-top:10px;}
        .screenshot-buttons {margin-top:10px;display:flex;gap:8px;}
    </style>
</head>
<body class="sb-nav-fixed">
<nav class="sb-topnav navbar navbar-expand navbar-dark bg-dark">
    <a class="navbar-brand ps-3" href="/" style="display: flex; align-items: center; gap: 10px;">
        <img src="/static/Logo.png" alt="Logo" style="height: 50px; width: auto;">
    </a>
    <ul class="navbar-nav ms-auto me-3">
        <li class="nav-item text-white d-flex align-items-center">Zalogowany jako: <b class="ms-2">{{ username }}</b></li>
        <li class="nav-item"><a href="/logout" class="btn btn-outline-danger btn-sm ms-3">Wyloguj</a></li>
    </ul>
</nav>
<div id="layoutSidenav">
    <div id="layoutSidenav_nav">
        <nav class="sb-sidenav accordion sb-sidenav-dark" id="sidenavAccordion">
            <div class="sb-sidenav-menu">
                <div class="nav">
                    <a class="nav-link" href="/">
                        <div class="sb-nav-link-icon"><i class="fas fa-home"></i></div>
                        Strona g≈Ç√≥wna
                    </a>
                    <a class="nav-link active" href="/wygeneruj-sociale">
                        <div class="sb-nav-link-icon"><i class="fas fa-share-alt"></i></div>
                        Wygeneruj Sociale
                    </a>
                    <a class="nav-link" href="/podsumowanie-socialmedia">
                        <div class="sb-nav-link-icon"><i class="fas fa-list-check"></i></div>
                        Podsumowanie SocialMedia
                    </a>
                </div>
            </div>
        </nav>
    </div>
    <div id="layoutSidenav_content">
        <main>
            <div class="container-fluid px-4 mt-4">
                <h1 class="mt-4">Wygeneruj Sociale</h1>
                <ol class="breadcrumb mb-4">
                    <li class="breadcrumb-item"><a href="/">Panel API</a></li>
                    <li class="breadcrumb-item active">Wygeneruj Sociale</li>
                </ol>
                <div class="card mb-4">
                    <div class="card-body">
                        {% if error %}
                        <div class="alert alert-danger">{{ error }}</div>
                        {% endif %}
                        {% if success %}
                        <div class="alert alert-success">{{ success }}</div>
                        {% endif %}
                        <form method="post" enctype="multipart/form-data" id="postForm" action="{{ url_for('wygeneruj_sociale') }}">
                            <div class="mb-3">
                                <label for="description" class="form-label">Opis postu</label>
                                <textarea name="description" id="description" class="form-control" rows="3" required minlength="10" maxlength="2000"></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="images" class="form-label">Zdjƒôcia (JPG/PNG, wiele)</label>
                                <input name="images" id="images" type="file" class="form-control" accept="image/jpeg,image/png" multiple required>
                            </div>
                            <div class="mb-3">
                                <label for="video" class="form-label">Film (MP4/MOV/AVI, opcjonalnie)</label>
                                <input name="video" id="video" type="file" class="form-control" accept="video/mp4,video/avi,video/mov">
                            </div>
                            <div class="mb-3">
                                <label for="send_at" class="form-label">Data wys≈Çania na n8n</label>
                                <input name="send_at" id="send_at" type="datetime-local" class="form-control">
                                <small class="text-muted">Data nie mo≈ºe byƒá wcze≈õniejsza ni≈º dzisiejsza</small>
                            </div>
                            <div class="mb-3">
                                <label for="location" class="form-label">Lokalizacja (opcjonalnie)</label>
                                <div class="input-group mb-2">
                                    <input name="location" id="location" type="text" class="form-control" placeholder="Wyszukaj lokalizacjƒô..." >
                                    <button type="button" class="btn btn-primary" id="searchLocationBtn"><i class="fas fa-search"></i> Szukaj</button>
                                </div>
                                <div id="map"></div>
                                <div id="locationInfo" class="location-info" style="display:none;">
                                    <strong>Wybrana lokalizacja:</strong><br>
                                    <span id="locationName"></span><br>
                                    <span class="location-coords">Szeroko≈õƒá: <span id="lat"></span></span><br>
                                    <span class="location-coords">D≈Çugo≈õƒá: <span id="lng"></span></span>
                                </div>
                                <div id="mapScreenshotContainer" class="map-screenshot-container">
                                    <div>
                                        <strong><i class="fas fa-camera"></i> Zrzut ekranu mapy</strong>
                                        <div class="screenshot-buttons">
                                            <button type="button" class="btn btn-sm btn-primary" id="downloadScreenshot"><i class="fas fa-download"></i> Pobierz PNG</button>
                                            <button type="button" class="btn btn-sm btn-secondary" id="retakeScreenshot"><i class="fas fa-redo"></i> Zr√≥b ponownie</button>
                                        </div>
                                    </div>
                                    <img id="mapScreenshot" class="map-screenshot-preview" alt="Screenshot mapy">
                                </div>
                                <input type="hidden" name="map_screenshot" id="map_screenshot" value="">
                            </div>
                            <button type="submit" class="btn btn-primary" id="submitBtn">Wy≈õlij post</button>
                            
                            <!-- Progress bar -->
                            <div id="uploadProgress" style="display: none; margin-top: 15px;">
                                <div class="progress" style="height: 25px;">
                                    <div id="uploadProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;">
                                        <span id="uploadProgressText" style="font-weight: bold; color: white;">0%</span>
                                    </div>
                                </div>
                                <p id="uploadStatus" style="margin-top: 10px; font-size: 14px; color: #666;">Wysy≈Çam plik...</p>
                            </div>
                        </form>
                        <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
                        <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-geocoder/2.6.0/Control.Geocoder.js"></script>
                        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-geocoder/2.6.0/Control.Geocoder.css" />
                        <script>
                            let map = null;
                            let marker = null;

                            function updateLocation(lat, lng) {
                                document.getElementById('lat').textContent = lat.toFixed(6);
                                document.getElementById('lng').textContent = lng.toFixed(6);
                                document.getElementById('locationInfo').style.display = 'block';
                                document.getElementById('location').value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;

                                if (marker) {
                                    map.removeLayer(marker);
                                }
                                marker = L.marker([lat, lng], {
                                    icon: L.icon({
                                        iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon.png',
                                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
                                        iconSize: [25, 41],
                                        shadowSize: [41, 41],
                                        popupAnchor: [1, -34]
                                    })
                                }).addTo(map).bindPopup(`Wsp√≥≈Çrzƒôdne: ${lat.toFixed(6)}, ${lng.toFixed(6)}`);
                                
                                setTimeout(() => captureMapScreenshot(), 500);
                            }

                            function captureMapScreenshot() {
                                const mapElement = document.getElementById('map');
                                html2canvas(mapElement, {
                                    backgroundColor: '#fff',
                                    scale: 2,
                                    logging: false,
                                    useCORS: true,
                                    allowTaint: true
                                }).then(canvas => {
                                    const imgData = canvas.toDataURL('image/png');
                                    document.getElementById('mapScreenshot').src = imgData;
                                    document.getElementById('mapScreenshotContainer').style.display = 'block';
                                    
                                    // Przechowaj canvas dla wys≈Çania z formularzem
                                    window.latestMapScreenshot = {
                                        data: imgData,
                                        canvas: canvas
                                    };
                                    
                                    console.log('‚úì Screenshot mapy przygotowany (bƒôdzie wys≈Çany z postem)');
                                }).catch(err => {
                                    console.error('B≈ÇƒÖd screenshot\'u:', err);
                                });
                            }

                            function performSearch() {
                                const locationInput = document.getElementById('location');
                                const searchTerm = locationInput.value.trim();
                                
                                console.log('Przycisk Szukaj klikniƒôty, tekst:', searchTerm);
                                
                                if (!searchTerm) {
                                    alert('Wpisz nazwƒô lokalizacji!');
                                    return;
                                }
                                
                                const queryUrl = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(searchTerm)}&format=json&limit=1`;
                                console.log('Wysy≈Çam zapytanie do:', queryUrl);
                                
                                fetch(queryUrl, {
                                    headers: {
                                        'User-Agent': 'SocialMediaApp'
                                    }
                                })
                                    .then(resp => resp.json())
                                    .then(data => {
                                        console.log('Odpowied≈∫ API:', data);
                                        if (!data || data.length === 0) {
                                            alert('‚ùå Nie znaleziono: ' + searchTerm);
                                            return;
                                        }
                                        const result = data[0];
                                        const lat = parseFloat(result.lat);
                                        const lng = parseFloat(result.lon);
                                        console.log('‚úì Znaleziono:', result.display_name, lat, lng);
                                        updateLocation(lat, lng);
                                        map.setView([lat, lng], 15);
                                        map.invalidateSize();
                                        document.getElementById('locationName').textContent = result.display_name || searchTerm;
                                    })
                                    .catch(err => {
                                        console.error('B≈ÇƒÖd:', err);
                                        alert('‚ùå B≈ÇƒÖd wyszukiwania: ' + err.message);
                                    });
                            }
                        </script>
                        {% if preview_images %}
                        <div class="mt-4 preview-label">PodglƒÖd dodanych zdjƒôƒá:</div>
                        <div class="preview-gallery">
                            {% for img in preview_images %}
                                <img src="/uploads/{{ img }}" class="preview-img" alt="PodglƒÖd zdjƒôcia">
                                <div class="text-center text-muted small mb-2">{{ img }}</div>
                            {% endfor %}
                        </div>
                        {% endif %} {% if preview_video %}
                        <div class="mt-4 preview-label">PodglƒÖd dodanego filmu:</div>
                        <video src="/uploads/{{ preview_video }}" controls class="preview-video"></video>
                        <div class="text-center text-muted small mb-2">{{ preview_video }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="card mb-4">
                    <div class="card-header"><i class="fa-solid fa-list"></i> Log wys≈Çanych post√≥w</div>
                    <div class="card-body">
                        {% for post in posts %}
                        <div class="mb-3 border-bottom pb-2">
                            <b>{{ post.created_at.strftime('%Y-%m-%d %H:%M') }}</b><br>
                            <span>{{ post.description }}</span><br>
                            {% if post.images %}
                                <div class="preview-gallery">
                                {% for img in post.images.split(',') %}
                                    <img src="/uploads/{{ img }}" class="preview-img" alt="PodglƒÖd zdjƒôcia">
                                {% endfor %}
                                </div>
                            {% endif %} {% if post.video %}
                                <video src="/uploads/{{ post.video }}" controls class="preview-video"></video>
                            {% endif %} {% if post.send_at %}
                                <div class="text-muted small">Wys≈Çane na n8n: {{ post.send_at.strftime('%Y-%m-%d %H:%M') }}</div>
                            {% endif %}
                        </div>
                        {% else %}
                        <span class="text-muted">Brak post√≥w.</span>
                        {% endfor %}
                    </div>
                </div>
                <div class="card mb-4">
                    <div class="card-header"><i class="fa-solid fa-list"></i> Ostatnio dodane pliki</div>
                    <div class="card-body">
                        {% if posts %}
                        <div class="preview-gallery">
                            {% for post in posts %}
                                {% if post.images %}
                                    {% for img in post.images.split(',') %}
                                        <img src="/uploads/{{ img }}" class="preview-img" alt="PodglƒÖd zdjƒôcia">
                                        <div class="text-center text-muted small mb-2">{{ img }}</div>
                                    {% endfor %}
                                {% endif %} {% if post.video %}
                                    <video src="/uploads/{{ post.video }}" controls class="preview-video"></video>
                                    <div class="text-center text-muted small mb-2">{{ post.video }}</div>
                                {% endif %}
                            {% endfor %}
                        </div>
                        {% else %}
                        <span class="text-muted">Brak plik√≥w.</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </main>
        <footer class="py-4 bg-light mt-auto">
            <div class="container-fluid px-4">
                <div class="d-flex align-items-center justify-content-between small">
                    <div class="text-muted">Copyright &copy; SocialMedia Flask API 2026</div>
                </div>
            </div>
        </footer>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/startbootstrap-sb-admin@7.0.6/dist/js/scripts.min.js"></script>
<script>
    // Inicjalizuj mapƒô i event listenery po za≈Çadowaniu strony
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM za≈Çadowany, inicjalizujƒô mapƒô...');
        
        // Ustaw minimalnƒÖ datƒô na dzisiejszƒÖ
        const now = new Date();
        const minDateTime = now.toISOString().slice(0, 16);
        const sendAtInput = document.getElementById('send_at');
        if (sendAtInput) sendAtInput.min = minDateTime;

        // Inicjalizuj mapƒô
        if (document.getElementById('map')) {
            map = L.map('map').setView([52.237, 21.022], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
            
            console.log('‚úì Mapa za≈Çadowana');
            
            // Klikniƒôcie na mapƒô
            map.on('click', (e) => {
                const lat = e.latlng.lat;
                const lng = e.latlng.lng;
                updateLocation(lat, lng);
            });
        }

        // Przycisk wyszukiwania
        const searchBtn = document.getElementById('searchLocationBtn');
        if (searchBtn) {
            console.log('‚úì Znaleziono przycisk Szukaj');
            searchBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('Klikniƒôto Szukaj');
                performSearch();
            });
        } else {
            console.error('‚ùå Nie znaleziono przycisku Szukaj');
        }

        // Enter w polu lokalizacji
        const locationInput = document.getElementById('location');
        if (locationInput) {
            locationInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    console.log('Enter w polu lokalizacji');
                    performSearch();
                }
            });
        }

        // Przycisk pobierania screenshot'u
        const downloadBtn = document.getElementById('downloadScreenshot');
        if (downloadBtn) {
            downloadBtn.addEventListener('click', function(e) {
                e.preventDefault();
                if (window.latestMapScreenshot) {
                    const link = document.createElement('a');
                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
                    link.href = window.latestMapScreenshot.data;
                    link.download = `mapa_${timestamp}.png`;
                    link.click();
                }
            });
        }

        // Przycisk ponowienia screenshot'u
        const retakeBtn = document.getElementById('retakeScreenshot');
        if (retakeBtn) {
            retakeBtn.addEventListener('click', function(e) {
                e.preventDefault();
                captureMapScreenshot();
            });
        }

        // Obs≈Çuga submit'a formularza - wysy≈õl screenshot razem z postem
        const postForm = document.getElementById('postForm');
        const submitBtn = document.getElementById('submitBtn');
        
        if (submitBtn) {
            submitBtn.addEventListener('click', function(e) {
                console.log('üîµ CLICK na przycisk - zaraz sprawdzƒô walidacjƒô');
            });
        }
        
        if (postForm) {
            console.log('‚úì Event listener dodany na formularz');
            postForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                console.log('üü¢ SUBMIT EVENT TRIGGERED!');
                console.log('Description:', document.getElementById('description').value);
                console.log('Images selected:', document.getElementById('images').files.length);
                console.log('Has map screenshot:', !!(window.latestMapScreenshot && window.latestMapScreenshot.canvas));
                
                // Je≈õli jest screenshot na canvas'u, dodaj go do FormData
                if (window.latestMapScreenshot && window.latestMapScreenshot.canvas) {
                    console.log('Konwertujƒô canvas do blob...');
                    window.latestMapScreenshot.canvas.toBlob(function(blob) {
                        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
                        const filename = `mapa_${timestamp}.png`;
                        
                        // Stw√≥rz formData ze wszystkimi danymi
                        const formData = new FormData(postForm);
                        
                        // Dodaj plik do formData
                        formData.append('map_screenshot_file', blob, filename);
                        console.log('‚úì Screenshot dodany do formData:', filename);
                        
                        // Loguj co jest w FormData
                        console.log('‚ïê‚ïê‚ïê FormData zawiera: ‚ïê‚ïê‚ïê');
                        for (let [key, value] of formData.entries()) {
                            if (value instanceof File || value instanceof Blob) {
                                console.log(`  ${key}: File/Blob - ${value.size} bytes`);
                            } else {
                                console.log(`  ${key}: ${value}`);
                            }
                        }
                        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

                        // Poka≈º progress bar
                        const uploadProgress = document.getElementById('uploadProgress');
                        const uploadProgressBar = document.getElementById('uploadProgressBar');
                        const uploadProgressText = document.getElementById('uploadProgressText');
                        const uploadStatus = document.getElementById('uploadStatus');
                        
                        uploadProgress.style.display = 'block';
                        uploadProgressBar.style.width = '0%';
                        uploadProgressText.textContent = '0%';
                        uploadStatus.textContent = 'Wysy≈Çam plik...';
                        submitBtn.disabled = true;
                        
                        // Wy≈õlij formularz za pomocƒÖ XMLHttpRequest (dla progress trackingu)
                        console.log('Wysy≈Çam formularz ze screenshot\'em...');
                        const xhr = new XMLHttpRequest();
                        
                        // Track progress
                        xhr.upload.addEventListener('progress', function(e) {
                            if (e.lengthComputable) {
                                const percentComplete = Math.round((e.loaded / e.total) * 100);
                                uploadProgressBar.style.width = percentComplete + '%';
                                uploadProgressText.textContent = percentComplete + '%';
                                console.log(`Upload: ${percentComplete}%`);
                            }
                        });
                        
                        // Obs≈Çuga b≈Çƒôdu
                        xhr.addEventListener('error', function() {
                            uploadStatus.textContent = '‚ùå B≈ÇƒÖd przy wysy≈Çaniu';
                            uploadProgressBar.className = 'progress-bar bg-danger';
                            submitBtn.disabled = false;
                            console.error('B≈ÇƒÖd uploadu');
                        });
                        
                        // Obs≈Çuga timeoutu
                        xhr.addEventListener('timeout', function() {
                            uploadStatus.textContent = '‚è± Timeout';
                            uploadProgressBar.className = 'progress-bar bg-warning';
                            submitBtn.disabled = false;
                        });
                        
                        // Obs≈Çuga sukcesu
                        xhr.addEventListener('load', function() {
                            console.log('XHR status:', xhr.status);
                            try {
                                const data = JSON.parse(xhr.responseText);
                                console.log('Response:', data);
                                
                                if (xhr.status === 200 && data.success) {
                                    uploadProgressBar.style.width = '100%';
                                    uploadProgressText.textContent = '100%';
                                    uploadProgressBar.className = 'progress-bar bg-success';
                                    uploadStatus.textContent = '‚úì ' + (data.message || 'Post wys≈Çany pomy≈õlnie!');
                                    console.log('‚úì Wys≈Çano pomy≈õlnie');
                                    setTimeout(() => {
                                        alert(data.message || '‚úì Post wys≈Çany pomy≈õlnie!');
                                        location.reload();
                                    }, 500);
                                } else {
                                    uploadStatus.textContent = '‚ùå ' + (data.message || 'B≈ÇƒÖd przy wysy≈Çaniu');
                                    uploadProgressBar.className = 'progress-bar bg-danger';
                                    alert(data.message || '‚ùå B≈ÇƒÖd przy wysy≈Çaniu posta');
                                    submitBtn.disabled = false;
                                }
                            } catch (e) {
                                uploadStatus.textContent = '‚ùå B≈ÇƒÖd parsowania odpowiedzi';
                                uploadProgressBar.className = 'progress-bar bg-danger';
                                submitBtn.disabled = false;
                                console.error('Parse error:', e);
                            }
                        });
                        
                        xhr.open('POST', postForm.action || window.location.pathname);
                        xhr.setRequestHeader('Accept', 'application/json');
                        xhr.send(formData);
                    }, 'image/png');
                } else {
                    // Wy≈õlij bez screenshot'u
                    console.log('Wysy≈Çam formularz bez screenshot\'u mapy');
                    const formData = new FormData(postForm);
                    
                    // Loguj co jest w FormData
                    console.log('‚ïê‚ïê‚ïê FormData zawiera: ‚ïê‚ïê‚ïê');
                    for (let [key, value] of formData.entries()) {
                        if (value instanceof File || value instanceof Blob) {
                            console.log(`  ${key}: File/Blob - ${value.size} bytes`);
                        } else {
                            console.log(`  ${key}: ${value}`);
                        }
                    }
                    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                    
                    // Poka≈º progress bar
                    const uploadProgress = document.getElementById('uploadProgress');
                    const uploadProgressBar = document.getElementById('uploadProgressBar');
                    const uploadProgressText = document.getElementById('uploadProgressText');
                    const uploadStatus = document.getElementById('uploadStatus');
                    
                    uploadProgress.style.display = 'block';
                    uploadProgressBar.style.width = '0%';
                    uploadProgressBar.className = 'progress-bar progress-bar-striped progress-bar-animated';
                    uploadProgressText.textContent = '0%';
                    uploadStatus.textContent = 'Wysy≈Çam plik...';
                    submitBtn.disabled = true;
                    
                    // Wy≈õlij za pomocƒÖ XMLHttpRequest
                    const xhr = new XMLHttpRequest();
                    
                    // Track progress
                    xhr.upload.addEventListener('progress', function(e) {
                        if (e.lengthComputable) {
                            const percentComplete = Math.round((e.loaded / e.total) * 100);
                            uploadProgressBar.style.width = percentComplete + '%';
                            uploadProgressText.textContent = percentComplete + '%';
                            console.log(`Upload: ${percentComplete}%`);
                        }
                    });
                    
                    // Obs≈Çuga b≈Çƒôdu
                    xhr.addEventListener('error', function() {
                        uploadStatus.textContent = '‚ùå B≈ÇƒÖd przy wysy≈Çaniu';
                        uploadProgressBar.className = 'progress-bar bg-danger';
                        submitBtn.disabled = false;
                        console.error('B≈ÇƒÖd uploadu');
                    });
                    
                    // Obs≈Çuga timeoutu
                    xhr.addEventListener('timeout', function() {
                        uploadStatus.textContent = '‚è± Timeout';
                        uploadProgressBar.className = 'progress-bar bg-warning';
                        submitBtn.disabled = false;
                    });
                    
                    // Obs≈Çuga sukcesu
                    xhr.addEventListener('load', function() {
                        console.log('XHR status:', xhr.status);
                        try {
                            const data = JSON.parse(xhr.responseText);
                            console.log('Response:', data);
                            
                            if (xhr.status === 200 && data.success) {
                                uploadProgressBar.style.width = '100%';
                                uploadProgressText.textContent = '100%';
                                uploadProgressBar.className = 'progress-bar bg-success';
                                uploadStatus.textContent = '‚úì ' + (data.message || 'Post wys≈Çany pomy≈õlnie!');
                                console.log('‚úì Wys≈Çano pomy≈õlnie');
                                setTimeout(() => {
                                    alert(data.message || '‚úì Post wys≈Çany pomy≈õlnie!');
                                    location.reload();
                                }, 500);
                            } else {
                                uploadStatus.textContent = '‚ùå ' + (data.message || 'B≈ÇƒÖd przy wysy≈Çaniu');
                                uploadProgressBar.className = 'progress-bar bg-danger';
                                alert(data.message || '‚ùå B≈ÇƒÖd przy wysy≈Çaniu posta');
                                submitBtn.disabled = false;
                            }
                        } catch (e) {
                            uploadStatus.textContent = '‚ùå B≈ÇƒÖd parsowania odpowiedzi';
                            uploadProgressBar.className = 'progress-bar bg-danger';
                            submitBtn.disabled = false;
                            console.error('Parse error:', e);
                        }
                    });
                    
                    xhr.open('POST', postForm.action || window.location.pathname);
                    xhr.setRequestHeader('Accept', 'application/json');
                    xhr.send(formData);
                }
            });
        }

        console.log('‚úì Wszystkie event listenery zainstalowane');
    });
</script>
</body>
</html>
